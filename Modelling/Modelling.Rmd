---
title: "Modelling"
author: "u1805379"
date: "17/11/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE) 
```

```{r libraries, include=FALSE}
library(ggplot2)
library(devtools)
source_url("https://raw.github.com/timleeman/ST344GroupProject/main/setup.R")
source_url("https://raw.github.com/timleeman/ST344GroupProject/main/getdata.R")
```

```{r data_import, include=FALSE}
covidData$date = as.Date(parse_date_time(covidData$date,orders=c("y","ym","ymd")))
TidyData <- covidData %>% group_by(country) 
TidyData <- mutate(TidyData, country = factor(country), continent = factor(continent))

```

```{r lockdown_length calculator,}
national_lockdowns <- auravisionData %>% filter(Level== "National") %>% select(-Level)
national_lockdowns <- national_lockdowns %>% mutate(national_lockdown_length = as.numeric(-difftime(`StartDate`, `EndDate`)))
colnames(national_lockdowns)[1] = "country"
national_lockdowns <- filter(national_lockdowns, country %in% chosenCountries)
head(national_lockdowns %>% select(country, national_lockdown_length) %>% arrange(national_lockdown_length),60)

```

```{r functions_to_get_lockdown_data_and_bind,}
selectData <- filter(covidData, country %in% chosenCountries)
#Function to select country

lockdown_start_date <- function(cou){
  a <- national_lockdowns %>% filter(country == cou) %>% select(`StartDate`)
  return(a$`StartDate`[1]) 
}

lockdown_end_date <- function(cou){
  a <- national_lockdowns %>% filter(country == cou) %>% select(`EndDate`)
  return(a$`EndDate`[1]) 
}

get_lockdown_data <- function(cou){
  lockdown_data <- selectData %>% filter(country == cou) %>% 
                    filter(date >= lockdown_start_date(cou)) %>%
                    filter(date < lockdown_end_date(cou)) %>%
                    mutate(days_in_lockdown = as.numeric(-difftime(lockdown_start_date(cou), date)/86400))
  return(lockdown_data)
}

lockdown_data <- data_frame()

for(cou in national_lockdowns$country){
  a <- get_lockdown_data(cou)
  lockdown_data <- rbind(a, lockdown_data)
}

```


```{r anaylsing_data,}
firstdiff <- function(x) {
  shifted <- c(0,x[1:(length(x)-1)])
  result = x-shifted
  which_negative = which(result<0)
  result[which_negative] = NA
  return(result) }
lockdown_data <- lockdown_data %>%
  mutate(daily_confirmed = firstdiff(confirmed))

head(lockdown_data,100)
```

```{r model_data,}
average_temperature <- import("https://raw.github.com/timleeman/ST344GroupProject/main/Modelling/average_temperature_edit.xlsx")
modelData <- lockdown_data %>% select(country, date, continent, gdp_capita, gcmr_retail_recreation, 
                                      gcmr_grocery_pharmacy, days_in_lockdown, income) %>%  distinct()

modelData <- left_join(modelData, average_temperature, by= "country")

modelData$gdp_capita <- scale(modelData$gdp_capita)
#modelData$average_temperature <- scale(modelData$average_temperature)
modelData <- modelData %>% na.omit() 
modelData <- modelData %>% mutate(days_squared = days_in_lockdown^2)


population_20_39 <- import("https://raw.github.com/timleeman/ST344GroupProject/main/Modelling/population_aged_20_39.xlsx")
population_20_39 <- select(population_20_39, country, `2019`)
population_40_59 <- import("https://raw.github.com/timleeman/ST344GroupProject/main/Modelling/population_aged_40_59.xlsx")
population_40_59 <- select(population_40_59, country, `2019`)
population_20_59 <- left_join(population_20_39, population_40_59, by= "country")
population_20_59 <- population_20_59 %>% transmute(country, pop_20_59= `2019.x` + `2019.y` )
modelData <- left_join(modelData, population_20_59, by= "country")

head(modelData,20)
```

```{r justification_for_first_model,}

plot_country_lockdown_gcmr_retail <- function(cou){
  a <- modelData %>% filter(country == cou)
  ggplot(a, aes(x= date, y= gcmr_retail_recreation)) + geom_line()
}

#plot_country_lockdown_gcmr_retail("Germany")


ggplot(modelData, aes(x=days_in_lockdown, y= gcmr_retail_recreation, group= country, col= average_temperature)) + geom_line()

ggplot(modelData %>% filter(continent== "North America"), aes(x=days_in_lockdown, y= gcmr_retail_recreation, group= country, col= income)) + geom_line() + facet_grid(~continent)

ggplot(modelData %>% filter(continent== "North America"), aes(x=days_in_lockdown, y= gcmr_retail_recreation, group= country, col= pop_20_59)) + geom_line()


```


```{r first_model,}

model1 <- lm(data= modelData, gcmr_retail_recreation ~ days_in_lockdown)
summary(model1)

```

```{r grouping_by_lockdown_length, warning=FALSE}
ggplot(national_lockdowns, aes(x= national_lockdown_length)) +
geom_histogram(breaks= seq(0,160,25)) 

#average_lockdown_length <- national_lockdowns %>% filter(national_lockdown_length <= 77 & national_lockdown_length > 48)
#average_lockdown_modelData <- modelData %>% filter(country %in% average_lockdown_length$country)


#next bit just adds a new variable lockdown category to national_lockdowns based on proposed lengths
lockdownCat <- c()
national_lockdowns <- filter(national_lockdowns, country %in% modelData$country)
for(i in seq(1:40)){
  if(national_lockdowns[i, ]$national_lockdown_length < 48){
    lockdownCat <- c(lockdownCat, "Short")
  }
  else if(national_lockdowns[i, ]$national_lockdown_length > 78){
    lockdownCat <- c(lockdownCat, "Long")
  }
  else{
    lockdownCat <- c(lockdownCat, "Medium")
  }
}
national_lockdowns <- national_lockdowns %>%mutate(lockdownCategory = lockdownCat)

#adds national_lockdowns data to modelData
modelData <- left_join(modelData, national_lockdowns, by = "country")
#gets rid of the Place column, it was causing probblems with stepwise regression and is basically useless here
modelData$Place <- NULL


#ggplot(average_lockdown_modelData, aes(x=days_in_lockdown, y= gcmr_retail_recreation, group= country, col= average_temperature)) + geom_line()

#model2 <- lm(data= average_lockdown_modelData, gcmr_retail_recreation ~ days_in_lockdown)
#summary(model2)

#A minimal and maximal model we want to consider, haven't yet considered interactions between variables
minModel <- glm(data = modelData, gcmr_retail_recreation ~ 1)
maxModel <- glm(data = modelData, gcmr_retail_recreation ~ gdp_capita + days_in_lockdown + 
                                                            average_temperature + 
                                                            national_lockdown_length + factor(lockdownCategory))

#stepwise regression backwards, forwards and both directions
autoBack <- step(maxModel, direction = "backward", scope = list("lower" = minModel))
autoForward <- step(minModel, direction = "forward", scope = list("upper" = maxModel))
autoBoth <- step(minModel, direction = "both", scope = list("lower" = minModel, "upper" = maxModel))
summary(autoBack)
summary(autoForward)
summary(autoBoth)
#Forward, backward and both directions stepwise regression all choose the same model which is encouraging

#Exhaustive search for best model
regsubsetsOut <- regsubsets(gcmr_retail_recreation ~ gdp_capita + days_in_lockdown + average_temperature + 
                               national_lockdown_length + factor(lockdownCategory), data = modelData)
plot(regsubsetsOut, scale = "Cp")
```



